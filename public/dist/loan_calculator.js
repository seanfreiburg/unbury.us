import{p as C,a as y,v as L}from"./validation.js";class g{constructor(n,e,a,o,s){this.id=n,this.loanName=e,this.currentBalance=a,this.minimumPayment=o,this.interestRate=s}setLoanField(n,e){switch(n){case"loan-name":this.loanName=e;break;case"current-balance":this.currentBalance=y(e);break;case"minimum-payment":this.minimumPayment=y(e);break;case"interest-rate":this.interestRate=C(e);break}}static validateField(n,e){return L(n,e)}}const f={loanResults:{loans:{},totals:{}},results(){const t=this.computeResults();return t==null?alert("The loan payoff is more than 122 years, longer than the oldest person ever. You probably need to pay more on the loan or you will never pay it off."):(this.drawTotalResults(t),this.drawLoanResults(t)),t},drawTotalResults(t){const n=$("#total-results-template").html(),a=Handlebars.compile(n)(t.totals);$("#total-results").empty().append(a),$("#total-results").hide().fadeIn("500")},drawLoanResults(t){const n=$("#loan-results-template").html(),a=Handlebars.compile(n)(t);$("#loan-results").empty().append(a),$("#loan-results").hide().fadeIn("500");for(const o in t.loans)window.Router.addLoanTableResultListener(o)},computeResults(){const t=window.loans,n=[];for(const e in t)n.push(t[e]);return this.calculate(n,window.payment_type,window.monthly_payment)},calculate(t,n,e){this.loanResults={loans:{},totals:{}};const a={},o={},s={},r={};let h=dayjs().startOf("month");for(const l in t){this.loanResults.loans[l]={rows:[],loan_name:t[l].loanName,total_date:"0",total_interest_paid:0,id:l,starting_balance:t[l].currentBalance},o[l]=t[l].currentBalance,s[l]=0,a[l]=t[l],this.logDefaultLine(l,h);const c=o[l]+s[l];this.logBalanceRemainingLine(l,c)}let i=0;for(;Object.keys(a).length>0;){if(i++,i>12*122)return null;h=h.add(1,"month");let l=e;for(const c in a)r[c]=a[c].minimumPayment,l=l-r[c],this.logDefaultLine(c,h);this.payMinimums(a,o,s,r),l=l+this.addLeftoverPayments(r),this.removePaidOffLoans(a,o,s,r),this.applyExtraPayments(a,o,s,n,l,r);for(const c in a){const b=o[c]+s[c];this.logBalanceRemainingLine(c,b)}this.addInterest(a,o,s)}return this.logTotals(h),this.loanResults},removePaidOffLoans(t,n,e,a){for(const o in t)n[o]+e[o]==0&&this.removeLoan(t,n,e,a,o)},removeLoan(t,n,e,a,o){delete t[o],delete n[o],delete e[o],delete a[o]},payMinimums(t,n,e,a){for(const o in t){const s=this.applyPayment(o,a[o],e,n);a[o]=s}},applyPayment(t,n,e,a){if(e[t]>n)return this.logInterestPaidLine(t,n),e[t]=e[t]-n,0;if(e[t]==n)return this.logInterestPaidLine(t,n),e[t]=e[t]-n,0;{this.logInterestPaidLine(t,e[t]);const o=n-e[t];return e[t]=0,this.principalApplyPayment(t,o,a)}},principalApplyPayment(t,n,e){if(e[t]>n)return this.logPrincipalPaidLine(t,n),e[t]=e[t]-n,0;if(e[t]==n)return this.logPrincipalPaidLine(t,n),e[t]=e[t]-n,0;{this.logPrincipalPaidLine(t,e[t]);const a=n-e[t];return e[t]=0,a}},addInterest(t,n,e){for(const a in t){const s=(n[a]+e[a])*(t[a].interestRate/100/12);e[a]=e[a]+this.preciseRound(s,2)}},applyExtraPayments(t,n,e,a,o,s){const r=this.sortLoans(t,n,e,a);for(const h in r){if(o==0||Object.keys(t).length==0)return o;o=this.applyPayment(r[h],o,e,n),n[r[h]]+e[r[h]]==0&&this.removeLoan(t,n,e,s,r[h])}return o},addLeftoverPayments(t){let n=0;for(const e in t)n+=t[e];return n},preciseRound(t,n){const e=Math.pow(10,n);return parseFloat((Math.round(t*e+(n>0?1:0)*(Math.sign(t)*(10/Math.pow(100,n))))/e).toFixed(n))},sortLoans(t,n,e,a){return a=="snowball"?Object.keys(t).sort(function(o,s){return e[o]+n[o]-(e[s]+n[s])}):Object.keys(t).sort(function(o,s){return t[s].interestRate-t[o].interestRate})},logDefaultLine(t,n){this.loanResults.loans[t].rows.push({date:"",payment:0,principal_paid:0,interest_paid:0,balance_remaining:0});const e=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];e.date=n.format("MMMM YYYY"),e.payment=0,e.principal_paid=0,e.interest_paid=0,e.balance_remaining=0},logPaymentLine(t,n){const e=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];e.payment+=this.preciseRound(n,2),e.payment=this.preciseRound(e.payment,2)},logPrincipalPaidLine(t,n){const e=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];e.principal_paid=this.preciseRound(e.principal_paid+n,2),this.logPaymentLine(t,n)},logInterestPaidLine(t,n){const e=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];e.interest_paid=this.preciseRound(e.interest_paid+n,2),this.logPaymentLine(t,n)},logBalanceRemainingLine(t,n){const e=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];e.balance_remaining+=this.preciseRound(n,2)},logTotals(t){this.loanResults.totals.total_date=t.format("MMMM YYYY");let n=0;for(const e in this.loanResults.loans){this.loanResults.loans[e].total_interest_paid=0;for(const a in this.loanResults.loans[e].rows)this.loanResults.loans[e].total_interest_paid+=this.loanResults.loans[e].rows[a].interest_paid;this.loanResults.loans[e].total_interest_paid=this.preciseRound(this.loanResults.loans[e].total_interest_paid,2),this.loanResults.loans[e].total_date=this.loanResults.loans[e].rows[this.loanResults.loans[e].rows.length-1].date,n+=this.loanResults.loans[e].total_interest_paid}this.loanResults.totals.total_interest_paid=this.preciseRound(n,2)}};let m=null;function R(t,n,e,a,o){const s=t.get(0).getContext("2d"),r=t.parent();m&&m.destroy();const h={labels:n.labels,datasets:n.datasets.map(function(l,c){return{label:"Loan "+c,data:l.data,backgroundColor:l.fillColor||l.backgroundColor,borderColor:l.strokeColor||l.borderColor,pointBackgroundColor:l.pointColor||l.pointBackgroundColor,pointBorderColor:l.pointStrokeColor||l.pointBorderColor||"#fff",fill:!0,tension:0}})},i={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,max:a*o,ticks:{stepSize:o,font:{family:"'HelveticaNeue-Light','Helvetica Neue','proxima-nova'",size:12},color:"#909090"},grid:{color:"rgba(0,0,0,.05)"}},x:{ticks:{font:{family:"'HelveticaNeue-Light','Helvetica Neue','proxima-nova'",size:12},color:"#909090"},grid:{color:"rgba(0,0,0,.05)"}}},elements:{point:{radius:3,borderWidth:1},line:{borderWidth:2}},animation:{duration:1e3,easing:"easeOutQuart"}};t.attr("width",r.width()),t.attr("height",400),m=new Chart(s,{type:"line",data:h,options:i}),$(window).off("resize.chart").on("resize.chart",function(){m&&(t.attr("width",r.width()),m.resize())})}const w={graph(t){const n=this.getData(t),e=$("#graph");$("#myChart").length||e.append("<h4 class='text-center'>Balance Remaining</h4>"+'<canvas id="myChart" height="400"></canvas>');const a=this.getSteps();R($("#myChart"),n,!1,a,this.getStepWidth(t,a))},getSteps(){return 20},getStepWidth(t,n){let e=0;for(const a in t.loans)for(let o=0;o<t.loans[a].rows.length;o++)e<parseFloat(String(t.loans[a].rows[o].balance_remaining))&&(e=parseFloat(String(t.loans[a].rows[o].balance_remaining)));return Math.round(e/n)},getData(t){let n=0,e="";const a=20;let o;const s=[],r=Object.keys(t.loans);r.sort(function(i,l){return t.loans[l].starting_balance-t.loans[i].starting_balance});const h=[];for(let i=0;i<r.length;i++){const l=r[i];t.loans[l].rows.length>n&&(n=t.loans[l].rows.length,e=l),t.loans[e].rows.length>a?o=Math.floor(t.loans[e].rows.length/a):o=1}for(let i=0;i<r.length;i++){const l=r[i];s[i]={...this.getColorHash(parseInt(l)),data:[]};for(let c=0;c<n;c+=o)t.loans[l].rows[c]?s[i].data.push(t.loans[l].rows[c].balance_remaining):s[i].data.push(0)}for(let i=0;i<t.loans[e].rows.length;i+=o)h.push(t.loans[e].rows[i].date);return{labels:h,datasets:s}},getColorHash(t){let n={};switch(t%5){case 0:n={fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff"};break;case 1:n={fillColor:"rgba(200,0,0,0.5)",strokeColor:"rgba(200,0,0,1)",pointColor:"rgba(200,0,0,1)",pointStrokeColor:"#fff"};break;case 2:n={fillColor:"rgba(50,50,50,0.5)",strokeColor:"rgba(50,50,50,1)",pointColor:"rgba(50,50,50,1)",pointStrokeColor:"#fff"};break;case 3:n={fillColor:"rgba(0,200,0,0.5)",strokeColor:"rgba(0,200,0,1)",pointColor:"rgba(0,200,0,1)",pointStrokeColor:"#fff"};break;case 4:n={fillColor:"rgba(0,0,200,0.5)",strokeColor:"rgba(0,0,200,1)",pointColor:"rgba(0,0,200,1)",pointStrokeColor:"#fff"};break}return n}},d={addLoan(){const t=window;t.auto_increment+=1;const n=t.auto_increment,e=$("#loan-input-template").html(),s=Handlebars.compile(e)({id:n});$("#loan-inputs").append(s),$("#loan"+n).hide().fadeIn("500"),t.loans[n]=new g(n,"",0,0,0),t.Router.addLoanDestroyListener(n),t.Router.addLoanInputListeners(n)},removeLoan(t){const n=$("#loan"+t);n.next().remove(),n.animate({height:0,opacity:0},"slow",function(){$(this).remove()}),delete window.loans[t]},loanInputChange(t,n,e){const a=$(e).val(),o=window.loans[t];g.validateField(n,a)?($(e).removeClass("input-error").addClass("input-success"),o.setLoanField(n,a)):$(e).removeClass("input-success").addClass("input-error")},valid(){return $(".input-error").length},hashString(){const t=window;let n="";n+="monthly_payment="+t.monthly_payment+"&";for(const e in t.loans){const a=t.loans[e];n+="name_"+a.id+"="+a.loanName+"&",n+="balance_"+a.id+"="+a.currentBalance+"&",n+="payment_"+a.id+"="+a.minimumPayment+"&",n+="rate_"+a.id+"="+a.interestRate+"&"}return n}},u={changePaymentType(t){const n=$(t);n.attr("id")=="avalanche-btn"?n.hasClass("btn-secondary")&&(n.removeClass("btn-secondary").addClass("btn-primary"),$("#snowball-btn").removeClass("btn-primary").addClass("btn-secondary"),window.payment_type="avalanche"):n.hasClass("btn-secondary")&&(n.removeClass("btn-secondary").addClass("btn-primary"),$("#avalanche-btn").removeClass("btn-primary").addClass("btn-secondary"),window.payment_type="snowball")},monthlyPaymentInputChange(){const t=$("#monthly-payment");let n=t.val(),e=0;const a=window.loans;for(const s in a)e+=a[s].minimumPayment;n=n.replace(/[$,]+/g,"");const o=f.preciseRound(Number(n),2);e=f.preciseRound(e,2),$.isNumeric(n)&&o>=e?window.monthly_payment=o:(window.monthly_payment=e,t.val(e))},calculate(){const t=window.loans;if(v(t)==0)alert("Add a loan!");else if(d.valid())alert("At least one of your loans is invalid!");else{const n=f.results();n&&w.graph(n)}},autoCalculate(){if(!d.valid()){const t=f.results();t&&w.graph(t)}}};function v(t){return Object.keys(t).length}const p={init(){$("#add-loan").click(function(){d.addLoan()}),$("#avalanche-btn").click(function(){u.changePaymentType(this),u.autoCalculate()}),$("#snowball-btn").click(function(){u.changePaymentType(this),u.autoCalculate()})},addMonthlyPaymentListener(){$("#monthly-payment").change(function(){u.monthlyPaymentInputChange(),location.hash=d.hashString(),u.autoCalculate()})},addLoanDestroyListener(t){$("#destroy-button-"+t).click(function(){d.removeLoan(t),location.hash=d.hashString(),u.autoCalculate()})},addLoanInputListeners(t){this.addLoanInputListener(t,"loan-name"),this.addLoanInputListener(t,"current-balance"),this.addLoanInputListener(t,"minimum-payment"),this.addLoanInputListener(t,"interest-rate")},addLoanInputListener(t,n){$("#loan"+t).find("input[name="+n+"]").change(function(){d.loanInputChange(t,n,this),u.monthlyPaymentInputChange(),location.hash=d.hashString(),u.autoCalculate()})},addCalculateListener(){$("#calculate").click(function(){u.calculate()})},addLoanTableResultListener(t){$("#loan-head-"+t).click(function(){$(this).next().next().toggle(),$(this).find(".bi-chevron-right").length>0?$(this).find(".arrow").removeClass("bi-chevron-right").addClass("bi-chevron-down"):$(this).find(".arrow").removeClass("bi-chevron-down").addClass("bi-chevron-right")})}};String.prototype.contains||(String.prototype.contains=function(t){return this.indexOf(t)!==-1});Math.sign=Math.sign||function(n){return n=+n,n===0||isNaN(n)?n:n>0?1:-1};window.Router=p;function _(){const t=window.location.hash;return t!=null&&t!=""?k(t):{}}function k(t){const n={},e=t.substr(1).split("&");for(let a=0;a<e.length;a++){const o=e[a].split("=");n[o[0]]=o[1]}return n}function P(t){const n=[];Object.keys(t).forEach(function(e){e.contains("name")&&n.push(e)});for(let e=0;e<n.length;e++){const a=n[e].split("_")[1];if(!(t["balance_"+a]!=null&&t["payment_"+a]!=null&&t["rate_"+a]!=null))return!1}return!0}function I(t){if(window.loans={},window.auto_increment=-1,window.monthly_payment=0,u.monthlyPaymentInputChange(),window.payment_type="avalanche",p.init(),p.addMonthlyPaymentListener(),p.addCalculateListener(),Handlebars.registerPartial("row",$("#loan-table-row-partial").html()),P(t)){t.monthly_payment&&$("#monthly-payment").val(t.monthly_payment);const n=[];Object.keys(t).forEach(function(e){e.contains("name")&&n.push(e)});for(let e=0;e<n.length;e++){const a=n[e].split("_")[1],o=parseInt(a,10);window.auto_increment=o;const s=a,r=$("#loan-input-template").html(),l=Handlebars.compile(r)({id:s});$("#loan-inputs").append(l),$("#loan"+s).hide().fadeIn("500"),window.loans[s]=new g(parseInt(s),"",0,0,0),p.addLoanDestroyListener(parseInt(s)),p.addLoanInputListeners(parseInt(s)),$("#loan-name-"+s).val(unescape(t["name_"+a])),$("#current-balance-"+s).val(t["balance_"+a]),$("#minimum-payment-"+s).val(t["payment_"+a]),$("#interest-rate-"+s).val(t["rate_"+a]);const c="change";$("#loan-name-"+s).trigger(c),$("#current-balance-"+s).trigger(c),$("#minimum-payment-"+s).trigger(c),$("#interest-rate-"+s).trigger(c)}}}$(function(){if(new URLSearchParams(window.location.search).get("jquery")==="true"){const e=_();I(e)}});
