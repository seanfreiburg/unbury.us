class g{constructor(e,n,a,o,l){this.id=e,this.loanName=n,this.currentBalance=a,this.minimumPayment=o,this.interestRate=l}setLoanField(e,n){switch(e){case"loan-name":this.loanName=n;break;case"current-balance":this.currentBalance=Number(n.replace(/[^0-9.]+/g,""));break;case"minimum-payment":this.minimumPayment=Number(n.replace(/[^0-9.]+/g,""));break;case"interest-rate":this.interestRate=Number(n.replace(/[^0-9.-]+/g,""));break}}static validateField(e,n){switch(e){case"loan-name":return n.length>0;case"current-balance":case"minimum-payment":return n=n.replace(/[$,]+/g,""),$.isNumeric(n)&&Number(n)>=0;case"interest-rate":return n=n.replace(/[$,%]+/g,""),$.isNumeric(n)}return!1}}const f={loanResults:{loans:{},totals:{}},results(){const t=this.computeResults();return t==null?alert("The loan payoff is more than 122 years, longer than the oldest person ever. You probably need to pay more on the loan or you will never pay it off."):(this.drawTotalResults(t),this.drawLoanResults(t)),t},drawTotalResults(t){const e=$("#total-results-template").html(),a=Handlebars.compile(e)(t.totals);$("#total-results").empty().append(a),$("#total-results").hide().fadeIn("500")},drawLoanResults(t){const e=$("#loan-results-template").html(),a=Handlebars.compile(e)(t);$("#loan-results").empty().append(a),$("#loan-results").hide().fadeIn("500");for(const o in t.loans)window.Router.addLoanTableResultListener(o)},computeResults(){const t=window.loans,e=[];for(const n in t)e.push(t[n]);return this.calculate(e,window.payment_type,window.monthly_payment)},calculate(t,e,n){this.loanResults={loans:{},totals:{}};const a={},o={},l={},i={};let h=dayjs().startOf("month");for(const s in t){this.loanResults.loans[s]={rows:[],loan_name:t[s].loanName,total_date:"0",total_interest_paid:0,id:s,starting_balance:t[s].currentBalance},o[s]=t[s].currentBalance,l[s]=0,a[s]=t[s],this.logDefaultLine(s,h);const c=o[s]+l[s];this.logBalanceRemainingLine(s,c)}let r=0;for(;Object.keys(a).length>0;){if(r++,r>12*122)return null;h=h.add(1,"month");let s=n;for(const c in a)i[c]=a[c].minimumPayment,s=s-i[c],this.logDefaultLine(c,h);this.payMinimums(a,o,l,i),s=s+this.addLeftoverPayments(i),this.removePaidOffLoans(a,o,l,i),this.applyExtraPayments(a,o,l,e,s,i);for(const c in a){const w=o[c]+l[c];this.logBalanceRemainingLine(c,w)}this.addInterest(a,o,l)}return this.logTotals(h),this.loanResults},removePaidOffLoans(t,e,n,a){for(const o in t)e[o]+n[o]==0&&this.removeLoan(t,e,n,a,o)},removeLoan(t,e,n,a,o){delete t[o],delete e[o],delete n[o],delete a[o]},payMinimums(t,e,n,a){for(const o in t){const l=this.applyPayment(o,a[o],n,e);a[o]=l}},applyPayment(t,e,n,a){if(n[t]>e)return this.logInterestPaidLine(t,e),n[t]=n[t]-e,0;if(n[t]==e)return this.logInterestPaidLine(t,e),n[t]=n[t]-e,0;{this.logInterestPaidLine(t,n[t]);const o=e-n[t];return n[t]=0,this.principalApplyPayment(t,o,a)}},principalApplyPayment(t,e,n){if(n[t]>e)return this.logPrincipalPaidLine(t,e),n[t]=n[t]-e,0;if(n[t]==e)return this.logPrincipalPaidLine(t,e),n[t]=n[t]-e,0;{this.logPrincipalPaidLine(t,n[t]);const a=e-n[t];return n[t]=0,a}},addInterest(t,e,n){for(const a in t){const l=(e[a]+n[a])*(t[a].interestRate/100/12);n[a]=n[a]+this.preciseRound(l,2)}},applyExtraPayments(t,e,n,a,o,l){const i=this.sortLoans(t,e,n,a);for(const h in i){if(o==0||Object.keys(t).length==0)return o;o=this.applyPayment(i[h],o,n,e),e[i[h]]+n[i[h]]==0&&this.removeLoan(t,e,n,l,i[h])}},addLeftoverPayments(t){let e=0;for(const n in t)e+=t[n];return e},preciseRound(t,e){const n=Math.pow(10,e);return parseFloat((Math.round(t*n+(e>0?1:0)*(Math.sign(t)*(10/Math.pow(100,e))))/n).toFixed(e))},sortLoans(t,e,n,a){if(a=="snowball")return Object.keys(t).sort(function(o,l){return n[o]+e[o]-(n[l]+e[l])});if(a=="avalanche")return Object.keys(t).sort(function(o,l){return t[l].interestRate-t[o].interestRate})},logDefaultLine(t,e){this.loanResults.loans[t].rows.push({});const n=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];n.date=e.format("MMMM YYYY"),n.payment=0,n.principal_paid=0,n.interest_paid=0,n.balance_remaining=0},logPaymentLine(t,e){const n=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];n.payment+=this.preciseRound(e,2),n.payment=this.preciseRound(n.payment,2)},logPrincipalPaidLine(t,e){const n=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];n.principal_paid=this.preciseRound(n.principal_paid+e,2),this.logPaymentLine(t,e)},logInterestPaidLine(t,e){const n=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];n.interest_paid=this.preciseRound(n.interest_paid+e,2),this.logPaymentLine(t,e)},logBalanceRemainingLine(t,e){const n=this.loanResults.loans[t].rows[this.loanResults.loans[t].rows.length-1];n.balance_remaining+=this.preciseRound(e,2)},logTotals(t){this.loanResults.totals.total_date=t.format("MMMM YYYY");let e=0;for(const n in this.loanResults.loans){this.loanResults.loans[n].total_interest_paid=0;for(const a in this.loanResults.loans[n].rows)this.loanResults.loans[n].total_interest_paid+=this.loanResults.loans[n].rows[a].interest_paid;this.loanResults.loans[n].total_interest_paid=this.preciseRound(this.loanResults.loans[n].total_interest_paid,2),this.loanResults.loans[n].total_date=this.loanResults.loans[n].rows[this.loanResults.loans[n].rows.length-1].date,e+=this.loanResults.loans[n].total_interest_paid}this.loanResults.totals.total_interest_paid=this.preciseRound(e,2)}};let p=null;function b(t,e,n,a,o){const l=t.get(0).getContext("2d"),i=$(t).parent();p&&p.destroy();const h={labels:e.labels,datasets:e.datasets.map(function(s,c){return{label:"Loan "+c,data:s.data,backgroundColor:s.fillColor||s.backgroundColor,borderColor:s.strokeColor||s.borderColor,pointBackgroundColor:s.pointColor||s.pointBackgroundColor,pointBorderColor:s.pointStrokeColor||s.pointBorderColor||"#fff",fill:!0,tension:0}})},r={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,max:a*o,ticks:{stepSize:o,font:{family:"'HelveticaNeue-Light','Helvetica Neue','proxima-nova'",size:12},color:"#909090"},grid:{color:"rgba(0,0,0,.05)"}},x:{ticks:{font:{family:"'HelveticaNeue-Light','Helvetica Neue','proxima-nova'",size:12},color:"#909090"},grid:{color:"rgba(0,0,0,.05)"}}},elements:{point:{radius:3,borderWidth:1},line:{borderWidth:2}},animation:{duration:1e3,easing:"easeOutQuart"}};t.attr("width",$(i).width()),t.attr("height",400),p=new Chart(l,{type:"line",data:h,options:r}),$(window).off("resize.chart").on("resize.chart",function(){p&&(t.attr("width",$(i).width()),p.resize())})}const y={graph(t){const e=this.getData(t),n=$("#graph");$("#myChart").length||n.append("<h4 class='text-center'>Balance Remaining</h4>"+'<canvas id="myChart" height="400"></canvas>');const a=this.getSteps();b($("#myChart"),e,!1,a,this.getStepWidth(t,a))},getSteps(){return 20},getStepWidth(t,e){let n=0;for(const a in t.loans)for(let o=0;o<t.loans[a].rows.length;o++)n<parseFloat(t.loans[a].rows[o].balance_remaining)&&(n=parseFloat(t.loans[a].rows[o].balance_remaining));return Math.round(n/e)},getData(t){let e=0,n=0;const a=20;let o;const l=[],i=Object.keys(t.loans);i.sort(function(r,s){return t.loans[s].starting_balance-t.loans[r].starting_balance});const h=[];for(let r=0;r<i.length;r++){const s=i[r];t.loans[s].rows.length>e&&(e=t.loans[s].rows.length,n=s),t.loans[n].rows.length>a?o=Math.floor(t.loans[n].rows.length/a):o=1}for(let r=0;r<i.length;r++){const s=i[r];l[r]=this.getColorHash(s),l[r].data=[];for(let c=0;c<e;c+=o)t.loans[s].rows[c]?l[r].data.push(t.loans[s].rows[c].balance_remaining):l[r].data.push(0)}for(let r=0;r<t.loans[n].rows.length;r+=o)h.push(t.loans[n].rows[r].date);return{labels:h,datasets:l}},getColorHash(t){t=parseInt(t);let e={};switch(t%5){case 0:e={fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff"};break;case 1:e={fillColor:"rgba(200,0,0,0.5)",strokeColor:"rgba(200,0,0,1)",pointColor:"rgba(200,0,0,1)",pointStrokeColor:"#fff"};break;case 2:e={fillColor:"rgba(50,50,50,0.5)",strokeColor:"rgba(50,50,50,1)",pointColor:"rgba(50,50,50,1)",pointStrokeColor:"#fff"};break;case 3:e={fillColor:"rgba(0,200,0,0.5)",strokeColor:"rgba(0,200,0,1)",pointColor:"rgba(0,200,0,1)",pointStrokeColor:"#fff"};break;case 4:e={fillColor:"rgba(0,0,200,0.5)",strokeColor:"rgba(0,0,200,1)",pointColor:"rgba(0,0,200,1)",pointStrokeColor:"#fff"};break}return e}},d={addLoan(){window.auto_increment+=1;const t=window.auto_increment,e=$("#loan-input-template").html(),o=Handlebars.compile(e)({id:t});$("#loan-inputs").append(o),$("#loan"+t).hide().fadeIn("500"),window.loans[t]=new g(t,0,0,0,0),window.Router.addLoanDestroyListener(t),window.Router.addLoanInputListeners(t)},removeLoan(t){const e=$("#loan"+t);e.next().remove(),e.animate({height:0,opacity:0},"slow",function(){$(this).remove()}),delete window.loans[t]},loanInputChange(t,e,n){const a=$(n).val(),o=window.loans[t];g.validateField(e,a)?($(n).removeClass("input-error").addClass("input-success"),o.setLoanField(e,a)):$(n).removeClass("input-success").addClass("input-error")},valid(){return $(".input-error").length},hashString(){let t="";t+="monthly_payment="+window.monthly_payment+"&";for(const e in window.loans){const n=window.loans[e];t+="name_"+n.id+"="+n.loanName+"&",t+="balance_"+n.id+"="+n.currentBalance+"&",t+="payment_"+n.id+"="+n.minimumPayment+"&",t+="rate_"+n.id+"="+n.interestRate+"&"}return t}},u={changePaymentType(t){const e=$(t);e.attr("id")=="avalanche-btn"?e.hasClass("btn-secondary")&&(e.removeClass("btn-secondary").addClass("btn-primary"),$("#snowball-btn").removeClass("btn-primary").addClass("btn-secondary"),window.payment_type="avalanche"):e.hasClass("btn-secondary")&&(e.removeClass("btn-secondary").addClass("btn-primary"),$("#avalanche-btn").removeClass("btn-primary").addClass("btn-secondary"),window.payment_type="snowball")},monthlyPaymentInputChange(){const t=$("#monthly-payment");let e=t.val(),n=0;for(const a in window.loans)n+=window.loans[a].minimumPayment;e=e.replace(/[$,]+/g,""),e=f.preciseRound(e,2),n=f.preciseRound(n,2),$.isNumeric(e)&&Number(e)>=n?window.monthly_payment=Number(e):(window.monthly_payment=n,t.val(n))},calculate(){if(C(window.loans)==0)alert("Add a loan!");else if(d.valid())alert("At least one of your loans is invalid!");else{const t=f.results();y.graph(t)}},autoCalculate(){if(!d.valid()){const t=f.results();y.graph(t)}}};function C(t){return Object.keys(t).length}const m={init(){$("#add-loan").click(function(){d.addLoan()}),$("#avalanche-btn").click(function(){u.changePaymentType(this),u.autoCalculate()}),$("#snowball-btn").click(function(){u.changePaymentType(this),u.autoCalculate()})},addMonthlyPaymentListener(){$("#monthly-payment").change(function(){u.monthlyPaymentInputChange(),location.hash=d.hashString(),u.autoCalculate()})},addLoanDestroyListener(t){$("#destroy-button-"+t).click(function(){d.removeLoan(t),location.hash=d.hashString(),u.autoCalculate()})},addLoanInputListeners(t){this.addLoanInputListener(t,"loan-name"),this.addLoanInputListener(t,"current-balance"),this.addLoanInputListener(t,"minimum-payment"),this.addLoanInputListener(t,"interest-rate")},addLoanInputListener(t,e){$("#loan"+t).find("input[name="+e+"]").change(function(){d.loanInputChange(t,e,this),u.monthlyPaymentInputChange(),location.hash=d.hashString(),u.autoCalculate()})},addCalculateListener(){$("#calculate").click(function(){u.calculate()})},addLoanTableResultListener(t){$("#loan-head-"+t).click(function(){$(this).next().next().toggle(),$(this).find(".bi-chevron-right").length>0?$(this).find(".arrow").removeClass("bi-chevron-right").addClass("bi-chevron-down"):$(this).find(".arrow").removeClass("bi-chevron-down").addClass("bi-chevron-right")})}};String.prototype.contains||(String.prototype.contains=function(t){return this.indexOf(t)!==-1});Math.sign=Math.sign||function(e){return e=+e,e===0||isNaN(e)?e:e>0?1:-1};window.Router=m;function L(){const t=window.location.hash;return t!=null&&t!=""?R(t):{}}function R(t){const e={},n=t.substr(1).split("&");for(let a=0;a<n.length;a++){const o=n[a].split("=");e[o[0]]=o[1]}return e}function v(t){const e=[];Object.keys(t).forEach(function(n){n.contains("name")&&e.push(n)});for(let n=0;n<e.length;n++){const a=e[n].split("_")[1];if(!(t["balance_"+a]!=null&&t["payment_"+a]!=null&&t["rate_"+a]!=null))return!1}return!0}function _(t){if(window.loans={},window.auto_increment=-1,window.monthly_payment=0,u.monthlyPaymentInputChange(),window.payment_type="avalanche",m.init(),m.addMonthlyPaymentListener(),m.addCalculateListener(),Handlebars.registerPartial("row",$("#loan-table-row-partial").html()),v(t)){t.monthly_payment&&$("#monthly-payment").val(t.monthly_payment);const e=[];Object.keys(t).forEach(function(n){n.contains("name")&&e.push(n)});for(let n=0;n<e.length;n++){const a=e[n].split("_")[1];window.auto_increment=a;const o=a,l=$("#loan-input-template").html(),r=Handlebars.compile(l)({id:o});$("#loan-inputs").append(r),$("#loan"+o).hide().fadeIn("500"),window.loans[o]=new g(o,0,0,0,0),m.addLoanDestroyListener(o),m.addLoanInputListeners(o),$("#loan-name-"+o).val(unescape(t["name_"+a])),$("#current-balance-"+o).val(t["balance_"+a]),$("#minimum-payment-"+o).val(t["payment_"+a]),$("#interest-rate-"+o).val(t["rate_"+a]);const s="change";$("#loan-name-"+o).trigger(s),$("#current-balance-"+o).trigger(s),$("#minimum-payment-"+o).trigger(s),$("#interest-rate-"+o).trigger(s)}}}$().ready(function(){const t=L();_(t)});
